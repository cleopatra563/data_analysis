# 用户人群标签计算流程图

## Mermaid语法流程图

```mermaid
flowchart TD
    A[开始: 输入用户行为数据] --> B[数据预处理: 去重、清洗]
    
    B --> C{按用户分组}
    C --> D[计算每个用户的活跃时间序列]
    
    D --> E{进入标签计算模块}
    
    %% 活跃用户计算分支
    E --> F[活跃用户计算]
    F --> F1{用户在观察周期内是否有活跃行为?}
    F1 -->|是| F2[标记为: 活跃用户]
    F1 -->|否| F3[不标记为活跃用户]
    
    %% 留存用户计算分支
    E --> G[留存用户计算]
    G --> G1{用户在基准周期内是否活跃?}
    G1 -->|是| G2{用户在目标周期内是否活跃?}
    G2 -->|是| G3[标记为: 留存用户]
    G2 -->|否| G4[不标记为留存用户]
    G1 -->|否| G4
    
    %% 回流用户计算分支
    E --> H[回流用户计算]
    H --> H1{用户在观察周期内是否活跃?}
    H1 -->|是| H2{用户在前N个连续周期内是否不活跃?}
    H2 -->|是| H3{用户在更早的周期内是否曾活跃?}
    H3 -->|是| H4[标记为: 回流用户]
    H3 -->|否| H5[不标记为回流用户]
    H2 -->|否| H5
    H1 -->|否| H5
    
    %% 流失用户计算分支
    E --> I[流失用户计算]
    I --> I1{用户在观察周期内是否不活跃?}
    I1 -->|是| I2{用户在前M个连续周期内是否不活跃?}
    I2 -->|是| I3{用户在更早的周期内是否曾活跃?}
    I3 -->|是| I4[标记为: 流失用户]
    I3 -->|否| I5[不标记为流失用户]
    I2 -->|否| I5
    I1 -->|否| I5
    
    %% 结果输出
    F2 --> J[输出用户标签结果]
    G3 --> J
    H4 --> J
    I4 --> J
    F3 --> J
    G4 --> J
    H5 --> J
    I5 --> J
    
    J --> K[结束]
```

## 详细计算逻辑说明

### 1. 数据预处理阶段
- **输入数据**：用户ID、行为时间戳、行为类型
- **数据清洗**：
  - 去除重复记录
  - 处理缺失值
  - 标准化时间格式
- **关键操作**：将行为时间按观察周期（日/周/月）进行分组

### 2. 活跃时间序列构建
- 为每个用户构建活跃时间序列，记录用户在每个时间周期是否活跃
- 活跃定义：在时间周期内有至少一次指定的活跃行为
- 输出：用户ID × 时间周期的活跃状态矩阵

### 3. 标签计算逻辑

#### 3.1 活跃用户计算
```
活跃用户 = 所有在观察周期内有活跃行为的用户
```

#### 3.2 留存用户计算
```
留存用户 = 
    用户集合 where (
        用户在基准周期内活跃 AND 
        用户在目标周期内活跃
    )
```

#### 3.3 回流用户计算
```
回流用户 = 
    用户集合 where (
        用户在观察周期内活跃 AND
        用户在流失观察窗口内（前N个周期）不活跃 AND
        用户在流失观察窗口之前曾有活跃记录
    )
```

#### 3.4 流失用户计算
```
流失用户 = 
    用户集合 where (
        用户在观察周期内不活跃 AND
        用户在连续流失阈值内（前M个周期）不活跃 AND
        用户在连续流失阈值之前曾有活跃记录
    )
```

### 4. 参数说明
| 参数 | 描述 | 默认值 |
|------|------|--------|
| 观察周期 | 计算活跃状态的时间窗口 | 日/周/月 |
| 活跃行为 | 定义用户是否活跃的行为类型 | 登录/核心功能使用 |
| 流失观察窗口 | 判定回流用户的流失时长 | 1-3个周期 |
| 连续流失阈值 | 判定流失用户的连续不活跃时长 | 3-6个周期 |
| 基准周期 | 计算留存的起始时间周期 | 通常为目标周期的前一个周期 |

### 5. 结果输出
- 输出格式：用户ID × 用户标签的矩阵
- 标签类型：活跃用户、留存用户、回流用户、流失用户
- 注意：同一用户可能同时被标记为多种标签（如活跃用户同时也是留存用户）